pipeline {

    agent {
            dockerfile {
                args "-v maven-repository:/home/docker/.m2"
            }
    }
    environment {
        MVN_GOAL = 'clean verify'
        M2_HOME = '/usr/share/maven'
        X_SCREEN = '1920x1080x16'
    }
    stages {
         stage('Execute tests') {
             steps {
                 wrap([$class: 'Xvfb', screen: "${env.X_SCREEN}", autoDisplayName: true]) {
                     sh "${env.M2_HOME}/bin/mvn ${env.MVN_GOAL}"
                 }
             }
         stage('Start container') {
             steps {
              sh 'docker compose up -d --no-color --wait'
              sh 'docker compose ps'
              }
          }
         stage('Run tests against the container') {
              steps {
                  sh 'curl http://localhost:4444/ui/index.html#/ | jq'
         }
     }
     post {
         always {
             allure([
                 includeProperties: false,
                 jdk: '',
                 properties: [],
                 reportBuildPolicy: 'ALWAYS',
                 results: [[path: 'target/allure-results']]
               ])
         }
     }
 }
}
